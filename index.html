<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P Chat</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { font-family: Arial, sans-serif; background:#f0f2f5; }
#chat-box { height: 70vh; overflow-y:auto; background:white; border-radius:8px; padding:10px; }
.msg { padding:8px 12px; margin:5px 0; border-radius:12px; max-width:70%; }
.msg-my { background:#4ecdc4; color:white; align-self:flex-end; }
.msg-other { background:#fff; color:#333; align-self:flex-start; }
#input-container { display:flex; gap:10px; margin-top:10px; }
#msg-input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; resize:none; }
</style>
</head>
<body>

<div class="container mt-4">
  <h3 class="text-center">P2P Chat</h3>
  <div id="chat-box" class="d-flex flex-column"></div>

  <div id="input-container">
    <textarea id="msg-input" rows="1" placeholder="Введите сообщение..."></textarea>
    <button class="btn btn-primary" onclick="send()">Отправить</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script>
const gun = Gun({ peers:['https://gunjs.herokuapp.com/gun'], localStorage:true });
const chat = gun.get('chat-room-v1');
let user = localStorage.getItem('chat_user') || '';
const chatBox = document.getElementById('chat-box');
const processedIds = new Set();

if (!user) {
  user = prompt('Введите имя:') || 'Гость';
  localStorage.setItem('chat_user', user);
}

function send() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;
  const msg = { id: Date.now() + '_' + Math.random().toString(36).slice(2,5), text, user, time: Date.now() };
  chat.set(msg);
  input.value = '';
}

chat.map().on(msg => {
  if (!msg || !msg.text || processedIds.has(msg.id)) return;
  processedIds.add(msg.id);

  const div = document.createElement('div');
  div.className = 'msg ' + (msg.user === user ? 'msg-my' : 'msg-other');
  const time = new Date(msg.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  div.innerHTML = `<b>${msg.user}:</b> ${msg.text} <span style="font-size:10px;color:#666;float:right">${time}</span>`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
});
</script>

</body>
</html>
